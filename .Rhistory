y.label = "Votes", x.label = "Margin of victory")
dev.off()
# lavin
h22 = rdbwselect(d$lavin99_p_s,d$margin,cluster = d$cluster)$bws[1]
summary(rdrobust(d$lavin99_p_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_lavin99_p_boptimal.pdf",
width=7,
height=7)
rdplot(y = d$lavin99_p_s, x = d$margin, h= h22, nbins = 100, subset = -h22 <= d$margin & d$margin <= h22,
binselect="esmv", kernel="triangular", col.lines = "black", col.dots = "black", p=1, y.lim = c(-1, 1), title =                                        "Robust CI: [-0.160 , 0.225]",
y.label = "Right-wing", x.label = "Margin of victory")
dev.off()
# lagos
h23 = rdbwselect(d$lagos99_p_s,d$margin,cluster = d$cluster)$bws[1]
summary(rdrobust(d$lagos99_p_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_lagos99_p_boptimal.pdf",
width=7,
height=7)
rdplot(y = d$lagos99_p_s, x = d$margin, h= h23, nbins = 100, subset = -h23 <= d$margin & d$margin <= h23,
binselect="esmv", kernel="triangular", col.lines = "black", col.dots = "black", p=1, y.lim = c(-1, 1), title =                                        "Robust CI: [-0.234 , 0.177]",
y.label = "Left-wing", x.label = "Margin of victory")
dev.off()
# invalid
h24 = rdbwselect(d$nulo99_p_s,d$margin,cluster = d$cluster)$bws[1]
summary(rdrobust(d$nulo99_p_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_nulo99_p_boptimal.pdf",
width=7,
height=7)
rdplot(y = d$nulo99_p_s, x = d$margin, h= h24, nbins = 100, subset = -h24 <= d$margin & d$margin <= h24,
binselect="esmv", kernel="triangular", col.lines = "black", col.dots = "black", p=1, y.lim = c(-1, 1), title =                                        "Robust CI: [-0.048 , 0.532]",
y.label = "Invalid", x.label = "Margin of victory")
dev.off()
# blank
h25 = rdbwselect(d$blanco99_p_s,d$margin,cluster = d$cluster)$bws[1]
summary(rdrobust(d$blanco99_p_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_blanco99_p_boptimal.pdf",
width=7,
height=7)
rdplot(y = d$blanco99_p_s, x = d$margin, h= h25, nbins = 100, subset = -h25 <= d$margin & d$margin <= h25,
binselect="esmv", kernel="triangular", col.lines = "black", col.dots = "black", p=1, y.lim = c(-1, 1), title =                                        "Robust CI: [-0.153 , 0.355]",
y.label = "Blank", x.label = "Margin of victory")
dev.off()
sink()
####################################
# Causal mechanisms RDROBUST
####################################
rm(list=ls())
sink("~/Dropbox/Crime Chile/02_analyses/05_causal_mech_crime.txt")
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
# load function that does clustered SEs
vcovCluster <- function(
model,
cluster
)
{
require(sandwich)
require(lmtest)
if(nrow(model.matrix(model))!=length(cluster)){
stop("check your data: cluster variable has different N than model")
}
M <- length(unique(cluster))
N <- length(cluster)
K <- model$rank
if(M<40){
warning("Fewer than 40 clusters, variances may be unreliable")
}
dfc <- (M/(M - 1)) * ((N - 1)/(N - K))
uj  <- apply(estfun(model), 2, function(x) tapply(x, cluster, sum));
rcse.cov <- dfc * sandwich(model, meat = crossprod(uj)/N)
return(rcse.cov)
}
################
# Prepare data
################
# read data
d = read.dta("~/Dropbox/Crime Chile/01_data/clean data/local_crime_data_chile_2021jan04.dta")
names(d)
# check transfers
tapply(d$total_tranfers_deflactor,d$year,mean)
mean(d$total_tranfers_deflactor, na.rm = T)
round(mean(d$total_tranfers_deflactor, na.rm = T)/mean(d$amount_projects_deflactor, na.rm = T),2)
sink()
####################################
# Causal mechanisms RDROBUST
####################################
rm(list=ls())
#sink("~/Dropbox/Crime Chile/02_analyses/05_causal_mech_crime.txt")
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
# load function that does clustered SEs
vcovCluster <- function(
model,
cluster
)
{
require(sandwich)
require(lmtest)
if(nrow(model.matrix(model))!=length(cluster)){
stop("check your data: cluster variable has different N than model")
}
M <- length(unique(cluster))
N <- length(cluster)
K <- model$rank
if(M<40){
warning("Fewer than 40 clusters, variances may be unreliable")
}
dfc <- (M/(M - 1)) * ((N - 1)/(N - K))
uj  <- apply(estfun(model), 2, function(x) tapply(x, cluster, sum));
rcse.cov <- dfc * sandwich(model, meat = crossprod(uj)/N)
return(rcse.cov)
}
################
# Prepare data
################
# read data
d = read.dta("~/Dropbox/Crime Chile/01_data/clean data/local_crime_data_chile_2021jan04.dta")
names(d)
# check transfers
tapply(d$total_tranfers_deflactor,d$year,mean)
mean(d$total_tranfers_deflactor, na.rm = T)
round(mean(d$total_tranfers_deflactor, na.rm = T)/mean(d$amount_projects_deflactor, na.rm = T),2)
tapply(d$total_tranfers_deflactor_per_s,d$year,mean,na.rm = T)
tapply(d$cons_elec_serv_com_def_per_s,d$year,mean,na.rm = T)
# bandwidth
h = rdbwselect(d$total_tranfers_deflactor_per_s,d$margin,cluster = d$cluster)$bws[1]
round(h,3)
# observations
sum(abs(d$margin)<=h)
# Total transfers
summary(rdrobust(d$total_tranfers_deflactor_per_s,d$margin,cluster = d$cluster,all=TRUE))
summary(rdrobust(d$total_tranfers_deflactor_per_s,d$margin,cluster = d$cluster,all=TRUE))
summary(rdrobust(d$cons_elec_serv_com_def_per_s,d$margin,cluster = d$cluster, all=TRUE))
summary(rdrobust(d$social_programs_per_s,d$margin,cluster = d$cluster,all=TRUE))
summary(rdrobust(d$employment_per_s,d$margin,cluster = d$cluster,all=TRUE))
####################################
# Causal mechanisms RDROBUST
####################################
rm(list=ls())
sink("~/Dropbox/Crime Chile/02_analyses/05_causal_mech_crime.txt")
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
################
# Prepare data
################
# read data
d = read.dta("~/Dropbox/Crime Chile/01_data/clean data/local_crime_data_chile_2021jan04.dta")
names(d)
# check transfers
tapply(d$total_tranfers_deflactor,d$year,mean)
mean(d$total_tranfers_deflactor, na.rm = T)
round(mean(d$total_tranfers_deflactor, na.rm = T)/mean(d$amount_projects_deflactor, na.rm = T),2)
###################################
# Effect of alignment on tranfers
###################################
# bandwidth
h = rdbwselect(d$total_tranfers_deflactor_per_s,d$margin,cluster = d$cluster)$bws[1]
round(h,3)
# observations
sum(abs(d$margin)<=h)
# Total transfers
summary(rdrobust(d$total_tranfers_deflactor_per_s,d$margin,cluster = d$cluster,all=TRUE))
# Plot
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_discretionarytranfers_boptimal.pdf",
width=7,
height=7)
(rdplot(y = d$total_tranfers_deflactor_s, x = d$margin,  h= 0.131, nbins = 100, subset = -0.131 <= d$margin & d$margin <= 0.131,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black",  y.lim = c(-0.5, 2), title = "                                       Robust CI: [0.051 , 0.683]",
y.label = "Discretionary tranfers", x.label = "Margin of victory"))
dev.off()
############################
# Electricity
############################
# consumo electricidad servicios comunitarios
summary(rdrobust(d$cons_elec_serv_com_def_per_s,d$margin,cluster = d$cluster, all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_electricity.pdf",
width=7,
height=7)
(rdplot(y = d$cons_elec_serv_com_def_per_s, x = d$margin,  h= 0.088, nbins = 100, subset = -0.088 <= d$margin & d$margin <= 0.088,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-1, 1), title = "                                       Robust CI: [-0.028 , 0.321]",
y.label = "Municipal electricity spending on services provided to the community", x.label = "Margin of victory"))
dev.off()
###################################
# More mechanisms
###################################
# Gastos Municipales Área de Gestión: Programas Sociales
summary(rdrobust(d$social_programs_per_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_socialprograms_boptimal.pdf",
width=7,
height=7)
(rdplot(y = d$social_programs_per_s, x = d$margin,  h= 0.199, nbins = 100, subset = -0.199 <= d$margin & d$margin <= 0.199,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-0.5, 2), title = "                                       Robust CI: [-0.454 , 0.193]",
y.label = "Social programs", x.label = "Margin of victory"))
dev.off()
# Personas Inscritas en la Municipalidad en Busca de un Empleo
summary(rdrobust(d$employment_per_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_employment_boptimal.pdf",
width=7,
height=7)
(rdplot(y = d$employment_per_s, x = d$margin,  h= 0.038, nbins = 100, subset = -0.038 <= d$margin & d$margin <= 0.038,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-0.1, 0.1), title = "                                       Robust CI: [-0.031 , 0.005]",
y.label = "Employment", x.label = "Margin of victory"))
dev.off()
sink()
##########################################
# Aligned adjacent municipality analysis
##########################################
rm(list=ls())
sink("~/Dropbox/Crime Chile/02_analyses/06_spillover_crime.txt")
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
library(gridExtra)
# load function that does clustered SEs
vcovCluster <- function(
model,
cluster
)
{
require(sandwich)
require(lmtest)
if(nrow(model.matrix(model))!=length(cluster)){
stop("check your data: cluster variable has different N than model")
}
M <- length(unique(cluster))
N <- length(cluster)
K <- model$rank
if(M<40){
warning("Fewer than 40 clusters, variances may be unreliable")
}
dfc <- (M/(M - 1)) * ((N - 1)/(N - K))
uj  <- apply(estfun(model), 2, function(x) tapply(x, cluster, sum));
rcse.cov <- dfc * sandwich(model, meat = crossprod(uj)/N)
return(rcse.cov)
}
################
# Prepare data
################
# reada data
d = read.dta("~/Dropbox/Crime Chile/01_data/clean data/local_crime_data_chile_2021jan04.dta")
names(d)
# control
d$t_spill2 = 1 - d$t_spill
# spill
table(d$t_spill)
table(d$total_adjacent_county)
##############################################################################################
# Aligned adjacent municipalitys 1: Interaction with binary indicator: Property street crime
##############################################################################################
# main regression
d2 = d[!is.na(d$propstreetcrime_s),]
d2 = d2[d2$total_adjacent_county!=0,]
h1 = rdbwselect(d2$propstreetcrime_s,d2$margin,cluster = d2$cluster)$bws[1]
X = d2$margin
center = 0
bw = h1
d2$kweights = kernelwts(X, center, bw, kernel = "triangular")
sum(d2$kweights!=0)
h1
# interaction 1
reg1 = lm(d2$propstreetcrime_s ~ d2$ruling + d2$t_spill + d2$t_spill*d2$ruling + d2$margin, weights = d2$kweights)
reg1_c <- round(coeftest(reg1, vcov = vcovCluster(reg1, cluster = d2$cluster)),4)
reg1_c
# interaction 2
reg2 = lm(d2$propstreetcrime_s ~ d2$ruling + d2$t_spill2 + d2$t_spill2*d2$ruling, weights = d2$kweights)
reg2_c <- round(coeftest(reg2, vcov = vcovCluster(reg2, cluster = d2$cluster)),4)
reg2_c
sink()
####################################
# Timing
####################################
rm(list=ls())
sink("~/Dropbox/Crime Chile/02_analyses/07_timing_crime.txt")
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
# load function that does clustered SEs
vcovCluster <- function(
model,
cluster
)
{
require(sandwich)
require(lmtest)
if(nrow(model.matrix(model))!=length(cluster)){
stop("check your data: cluster variable has different N than model")
}
M <- length(unique(cluster))
N <- length(cluster)
K <- model$rank
if(M<40){
warning("Fewer than 40 clusters, variances may be unreliable")
}
dfc <- (M/(M - 1)) * ((N - 1)/(N - K))
uj  <- apply(estfun(model), 2, function(x) tapply(x, cluster, sum));
rcse.cov <- dfc * sandwich(model, meat = crossprod(uj)/N)
return(rcse.cov)
}
################
# Prepare data
################
# reada data
d = read.dta("~/Dropbox/Crime Chile/01_data/clean data/local_crime_data_chile_2021jan04.dta")
names(d)
############################
# Results
############################
# bandwidth
h0 = rdbwselect(d$propstreetcrime_s,d$margin,cluster = d$cluster)$bws[1]
# timing
d2 = d[!is.na(d$propstreetcrime_s),]
X = d2$margin
center = 0
bw = h0
d2$kweights = kernelwts(X, center, bw, kernel = "triangular")
# effect of alignment
sum(d2$kweights!=0)
h0
reg1 = lm(d2$propstreetcrime_s ~ d2$ruling + d2$margin + as.factor(d2$timing) + d2$ruling*as.factor(d2$timing), weights = d2$kweights)
reg1_c <- round(coeftest(reg1, vcov = vcovCluster(reg1, cluster = d2$cluster)),4)
reg1_c
sink()
####################################
# Placebo RDROBUST
####################################
rm(list=ls())
sink("~/Dropbox/Crime Chile/02_analyses/08_rdrobust_placebo_crime.txt")
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
################
# Prepare data
################
# read data
d = read.dta("~/Dropbox/Crime Chile/01_data/clean data/local_crime_data_chile_2021jan04.dta")
names(d)
############################
# RDrobust MSE
############################
# disturbing the peace (DTP)
summary(rdrobust(d$truidos_molestos_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_disturbingthepeace.pdf",
width=7,
height=7)
(rdplot(y = d$truidos_molestos_s, x = d$margin,  h= 0.148, nbins = 100, subset = -0.148 <= d$margin & d$margin <= 0.148,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-1, 1), title = "                                       Robust CI: [-0.332 , 0.076]",
y.label = "Disturbing the peace", x.label = "Margin of victory"))
dev.off()
# domestic violence against the elderly (DVE)
summary(rdrobust(d$tviolencia_adultomayor_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_domesticviolenceagainsttheelderly.pdf",
width=7,
height=7)
(rdplot(y = d$tviolencia_adultomayor_s, x = d$margin,  h= 0.125, nbins = 100, subset = -0.125 <= d$margin & d$margin <= 0.125,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-1, 1), title = "                                       Robust CI: [-0.083 , 0.389]",
y.label = "Domestic violence against the elderly", x.label = "Margin of victory"))
dev.off()
# domestic violence against men (DVM)
summary(rdrobust(d$tviolencia_hombre_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_domesticviolenceagainstmen.pdf",
width=7,
height=7)
(rdplot(y = d$tviolencia_hombre_s, x = d$margin,  h= 0.152, nbins = 100, subset = -0.152 <= d$margin & d$margin <= 0.152,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-1, 1), title = "                                       Robust CI: [-0.127 , 0.330]",
y.label = "Domestic violence against men", x.label = "Margin of victory"))
dev.off()
# domestic violence against women (DVW)
summary(rdrobust(d$tviolencia_mujer_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_domesticviolenceagainstwomen.pdf",
width=7,
height=7)
(rdplot(y = d$tviolencia_mujer_s, x = d$margin,  h= 0.238, nbins = 100, subset = -0.238 <= d$margin & d$margin <= 0.238,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-1, 1), title = "                                       Robust CI: [-0.262 , 0.240]]",
y.label = "Domestic violence against women", x.label = "Margin of victory"))
dev.off()
# domestic violence against children (DVC)
summary(rdrobust(d$tviolencia_ninos_s,d$margin,cluster = d$cluster,all=TRUE))
cairo_pdf(file="~/Dropbox/Crime Chile/03_manuscript/figures/f_rdd_domesticviolenceagainstchildren.pdf",
width=7,
height=7)
(rdplot(y = d$tviolencia_ninos_s, x = d$margin,  h= 0.219, nbins = 100, subset = -0.219 <= d$margin & d$margin <= 0.219,
binselect="esmv", kernel="triangular", p=1, col.lines = "black", col.dots = "black", y.lim = c(-1, 1), title = "                                       Robust CI: [-0.334 , 0.155]",
y.label = "Domestic violence against children", x.label = "Margin of victory"))
dev.off()
sink()
install.packages(c("lfe", "lmtest", "msm", "sandwich", "stargazer"))
################################
# DID cluster standard errors
################################
rm (list = ls())
#sink("~/Dropbox/Climate change and disasters/02_analyses/11_DID_cluster.txt")
library(foreign)
library(lmtest)
library(sandwich)
library(stargazer)
library(msm)
library(Hmisc)
library(ggplot2)
library(lfe)
library(data.table)
library(tidyverse)
library(readstata13)
library(gridExtra)
library(ggpubr)
library(grid)
###############################
# Load and prepare clean data
###############################
# load
load("~/Dropbox/Far Right Chile/01_data/clean_data/clean_panel_immigration_2020dec28.RData")
names(d)
dim(d)
# year
d$year = 2016
d$year[d$ola=="2017"] = 2017
d$year[d$ola=="2018"] = 2018
table(d$year)
# check zero visas
tapply(d$visas2015,d$county,mean)
tapply(d$visas2016,d$county,mean)
tapply(d$visas2017,d$county,mean)
# change between year 2 and year 1 (change in %)
d$change = 0
d$change[d$year==2016] = (d$visas2015[d$year==2016] - d$visas2014[d$year==2016])/(d$visas2014[d$year==2016])
d$change[d$year==2017] = (d$visas2016[d$year==2017] - d$visas2015[d$year==2017])/(d$visas2015[d$year==2017])
d$change[d$year==2018] = (d$visas2017[d$year==2018] - d$visas2016[d$year==2018])/(d$visas2016[d$year==2018])
describe(d$change)
mean(d$change)
sd(d$change)
min(d$change)
hist(d$change)
# mean and sd
mean_2016 = mean(d$change[d$year==2016])
mean_2017 = mean(d$change[d$year==2017])
mean_2018 = mean(d$change[d$year==2018])
mean_2016
mean_2017
mean_2018
sd_2016 = sd(d$change[d$year==2016])
sd_2017 = sd(d$change[d$year==2017])
sd_2018 = sd(d$change[d$year==2018])
sd_2016
sd_2017
sd_2018
# treatment
d$t_ind = 0
d$t_ind[d$year==2016 & d$change >= (mean_2016 + sd_2016)] = 1
d$t_ind[d$year==2017 & d$change >= (mean_2017 + sd_2017)] = 1
d$t_ind[d$year==2018 & d$change >= (mean_2018 + sd_2018)] = 1
table(d$t_ind, exclude = NULL)
table(d$t_ind,d$year)
#######################
# Results treatment 1
#######################
# change ordinal outcome
m2 = felm(proud_chilean  ~ change | idencuesta + year | 0 | idencuesta, data = d, keepCX = TRUE)
summary(m2)
pe2 = as.numeric(m2$beta)[1]
se2 = sqrt(diag(vcov(m2)))[1]
m2 = felm(identify_chile  ~ change| idencuesta + ola | 0 | idencuesta, data = d, keepCX = TRUE)
summary(m2)
pe2 = as.numeric(m2$beta)[1]
se2 = sqrt(diag(vcov(m2)))[1]
summary(m2)
summary(m2)
summary(m2)
summary(m2)
summary(m2)
# change ordinal outcome
m2 = felm(proud_chilean  ~ change | idencuesta + year | 0 | idencuesta, data = d, keepCX = TRUE)
summary(m2)
m3 = felm(identify_chile  ~ change| idencuesta + ola | 0 | idencuesta, data = d, keepCX = TRUE)
summary(m3)
# change ordinal outcome
m2 = felm(proud_chilean  ~ change | idencuesta + year | 0 | idencuesta, data = d, keepCX = TRUE)
summary(m2)
summary(m3)
###############################
# All visas and crime concerns
###############################
rm(list=ls())
####################################
# Validity checks
####################################
rm(list=ls())
