table(d$electoral_roll)
d$registered = NA
d$registered[d$electoral_roll==1]=1
d$registered[d$electoral_roll==2]=0
table(d$registered)
# political interest
table(d$interest_politics)
# vote habit
table(d$vote_habit)
# government aproval
table(d$gov_approval, exclude = NULL)
d$gov_approval_bin = 0
d$gov_approval_bin[d$gov_approval==1]=1
d$gov_approval_bin[d$gov_approval==2]=1
d$gov_approval_bin[d$gov_approval==3]=1
table(d$gov_approval_bin, exclude = NULL)
# subset
table(d$cep)
d00 = d[d$cep < 40,] # < 2000
d05 = d[d$cep < 52,] # < 2005
d10 = d[d$cep < 64,] # < 2010
d15 = d[d$cep < 77,] # < 2015
table(d$cep)
table(d00$cep)
table(d05$cep)
table(d10$cep)
table(d15$cep)
table(abs(d$margin)<50)
table(abs(d00$margin)<50)
table(abs(d05$margin)<50)
table(abs(d10$margin)<50)
table(abs(d15$margin)<50)
kweights = 0
pe = rep(NA,30)
se = rep(NA,30)
for (i in 1:30) {
kweights = kernelwts(d00$margin, 0, bw = (i+20), kernel = "triangular")
pe[i] = coef(summary(lm(d00$gov_approval_bin ~ d00$treatment + d00$margin + d00$treatment*d00$margin + as.factor(d00$cep) + as.factor(d00$region), weights = kweights)))[2, 1]
se[i] = coef(summary(lm(d00$gov_approval_bin ~ d00$treatment + d00$margin + d00$treatment*d00$margin + as.factor(d00$cep) + as.factor(d00$region), weights = kweights)))[2, 2]
}
days = c(21:50)
ts = pe/se
ts
lower95 = pe - se*1.960
upper95 = pe + se*1.960
lower90 = pe - se*1.650
upper90 = pe + se*1.650
results = data.frame(days,pe,se,ts,lower90,upper90,lower95,upper95)
head(results)
ggplot(results, aes(x=days, y=pe)) + geom_pointrange(aes(ymin=lower90,ymax=upper90),size=0.85,position = position_dodge(0.9)) + geom_pointrange(aes(ymin=lower95,ymax=upper95)) + scale_y_continuous(breaks=c(-3,-2.5,-2,-1.5,-1,-0.5,0,0.5,1,1.5,2,2.5,3)) + coord_cartesian(ylim=c(-3,3)) + geom_hline(yintercept=0) + xlab("Bandwidth") + ylab("RDD estimates") + ggtitle("1995-2000") + theme_bw() + theme(plot.title = element_text(hjust=0.5))
NAMES(D)
names(d)
table(d$vote_last_election)
# party id
table(d$party_id, exclude = NULL)
table(d$party_id, exclude = NULL)
d$party_id_bin = NA
d$party_id_bin[d$party_id<16]=1
d$party_id_bin[d$party_id==77]=0
d$party_id_bin[d$party_id==88]=0
d$party_id_bin[d$party_id==99]=0
table(d$party_id_bin, exclude = NULL)
table(d$party_id, exclude = NULL)
table(d$party_id, exclude = NULL)
d$party_id_bin = NA
d$party_id_bin[d$party_id<16]=1
d$party_id_bin[d$party_id==77]=0
d$party_id_bin[d$party_id==88]=0
d$party_id_bin[d$party_id==99]=0
table(d$party_id_bin, exclude = NULL)
3870  + 968  +   849
table(d$party_id, exclude = NULL)
d$party_id
d$party_id = as.numeric(d$party_id)
table(d$party_id, exclude = NULL)
d$party_id_bin = NA
d$party_id_bin[d$party_id<16]=1
d$party_id_bin[d$party_id==77]=0
d$party_id_bin[d$party_id==88]=0
d$party_id_bin[d$party_id==99]=0
table(d$party_id_bin, exclude = NULL)
d$party_id = as.numeric(d$party_id)
table(d$party_id, exclude = NULL)
d$party_id_bin = 0
d$party_id_bin[d$party_id<10]=1
table(d$party_id_bin, exclude = NULL)
table(d$coalition_id, exclude = NULL)
####################################
# Main effect RDD
####################################
rm(list=ls())
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
################
# Prepare data
################
# reada data
d = read.dta13("~/Dropbox/Plebiscite Chile/01_data/clean data/cep_data_05feb2019.dta")
names(d)
table(d$cep, exclude = NULL)
table(d$cep,d$ideology_label)
# check data
table(d$year_of_birth, exclude = NULL)
d$year_miss = 0
d$year_miss[d$year_of_birth==999999]=1
table(d$year_miss)
table(d$cep,d$year_miss)
table(d$ideology_label, exclude = NULL)
table(d$cep,d$ideology_label, exclude = NULL)
# year of birth
table(d$year_of_birth, exclude = NULL)
d$year_of_birth[d$year_of_birth==99]=NA
d$year_of_birth[d$year_of_birth==2090]=NA
d$year_of_birth[d$year_of_birth==9999]=NA
d$year_of_birth[d$year_of_birth==999999]=NA
d$year_of_birth[d$year_of_birth==""]=NA
table(d$year_of_birth, exclude = NULL)
table(d$month_of_birth, exclude = NULL)
d$month_of_birth[d$month_of_birth==13]=NA
d$month_of_birth[d$month_of_birth==99]=NA
d$month_of_birth[d$month_of_birth==999999]=NA
d$month_of_birth[d$month_of_birth==""]=NA
table(d$month_of_birth, exclude = NULL)
table(d$day_of_birth, exclude = NULL)
d$day_of_birth[d$day_of_birth==0]=NA
d$day_of_birth[d$day_of_birth==39]=NA
d$day_of_birth[d$day_of_birth==99]=NA
d$day_of_birth[d$day_of_birth==999999]=NA
d$day_of_birth[d$day_of_birth==""]=NA
table(d$day_of_birth, exclude = NULL)
# subset
d = d[!is.na(d$year_of_birth),]
d = d[!is.na(d$month_of_birth),]
d = d[!is.na(d$day_of_birth),]
table(d$year_of_birth, exclude = NULL)
table(d$month_of_birth, exclude = NULL)
table(d$day_of_birth, exclude = NULL)
# margin
d$year_of_birth = as.numeric(d$year_of_birth)
d$month_of_birth = as.numeric(d$month_of_birth)
d$day_of_birth = as.numeric(d$day_of_birth)
d$birthday <- paste(d$year_of_birth, d$month_of_birth,d$day_of_birth, sep = "-")
describe(d$birthday)
d$eligibility = "1970-10-05"
d$margin = as.Date(as.character(d$eligibility), format="%Y-%m-%d") - as.Date(as.character(d$birthday), format="%Y-%m-%d")
d$margin = as.numeric(d$margin)
describe(d$margin)
d = d[!is.na(d$margin),] # imposible birthdates
d$margin[d$margin>=0] = d$margin[d$margin>=0] + 1
describe(d$margin)
table(d$cep, exclude = NULL)
# treatment
d$treatment = 0
d$treatment[d$margin>0]=1
table(d$treatment)
table(d$margin[d$treatment==1])
table(d$margin[d$treatment==0])
# ideological outcomes
table(d$ideology_label, exclude = NULL)
d$ideology_label = as.numeric(d$ideology_label)
table(d$ideology_label, exclude = NULL)
d$ideo_label = d$ideology_label
d$ideo_label[d$ideo_label>5] = NA
table(d$ideo_label, exclude = NULL)
table(d$cep,d$ideo_label)
d$ideo_bin = 0
d$ideo_bin[d$ideology_label==1] = 1
d$ideo_bin[d$ideology_label==2] = 1
d$ideo_bin[d$ideology_label==3] = 1
d$ideo_bin[d$ideology_label==4] = 1
d$ideo_bin[d$ideology_label==5] = 1
d$ideo_bin[d$ideology_label==6] = 0
d$ideo_bin[d$ideology_label==7] = 0
table(d$ideo_bin, exclude = NULL)
#d = d[!is.na(d$ideo_bin),]
#table(d$ideo_bin, exclude = NULL)
d$right = 0
d$right[d$ideo_label==1]=1
d$right[d$ideo_label==2]=1
table(d$right)
d$left = 0
d$left[d$ideo_label==4]=1
d$left[d$ideo_label==5]=1
table(d$left)
d$center = 0
d$center[d$ideo_label==3]=1
table(d$center)
# drop no ideological label
table(d$cep,d$ideology_label)
####################################
# Main effect RDD
####################################
rm(list=ls())
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
################
# Prepare data
################
# reada data
d = read.dta13("~/Dropbox/Plebiscite Chile/01_data/clean data/cep_data_05feb2019.dta")
names(d)
table(d$cep, exclude = NULL)
table(d$cep,d$ideology_label)
# check data
table(d$year_of_birth, exclude = NULL)
d$year_miss = 0
d$year_miss[d$year_of_birth==999999]=1
table(d$year_miss)
table(d$cep,d$year_miss)
table(d$ideology_label, exclude = NULL)
table(d$cep,d$ideology_label, exclude = NULL)
table(d$year_miss)
table(d$cep,d$year_miss)
####################################
# Main effect RDD
####################################
rm(list=ls())
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
################
# Prepare data
################
# reada data
d = read.dta13("~/Dropbox/Plebiscite Chile/01_data/clean data/cep_data_05feb2019.dta")
names(d)
table(d$cep, exclude = NULL)
table(d$cep,d$ideology_label)
# check data
table(d$year_of_birth, exclude = NULL)
d$year_miss = 0
d$year_miss[d$year_of_birth==999999]=1
table(d$year_miss)
table(d$cep,d$year_miss)
table(d$ideology_label, exclude = NULL)
table(d$cep,d$ideology_label, exclude = NULL)
# year of birth
table(d$year_of_birth, exclude = NULL)
d$year_of_birth[d$year_of_birth==99]=NA
d$year_of_birth[d$year_of_birth==2090]=NA
d$year_of_birth[d$year_of_birth==9999]=NA
d$year_of_birth[d$year_of_birth==999999]=NA
d$year_of_birth[d$year_of_birth==""]=NA
table(d$year_of_birth, exclude = NULL)
table(d$month_of_birth, exclude = NULL)
d$month_of_birth[d$month_of_birth==13]=NA
d$month_of_birth[d$month_of_birth==99]=NA
d$month_of_birth[d$month_of_birth==999999]=NA
d$month_of_birth[d$month_of_birth==""]=NA
table(d$month_of_birth, exclude = NULL)
table(d$day_of_birth, exclude = NULL)
d$day_of_birth[d$day_of_birth==0]=NA
d$day_of_birth[d$day_of_birth==39]=NA
d$day_of_birth[d$day_of_birth==99]=NA
d$day_of_birth[d$day_of_birth==999999]=NA
d$day_of_birth[d$day_of_birth==""]=NA
table(d$day_of_birth, exclude = NULL)
# subset
d = d[!is.na(d$year_of_birth),]
d = d[!is.na(d$month_of_birth),]
d = d[!is.na(d$day_of_birth),]
table(d$year_of_birth, exclude = NULL)
table(d$month_of_birth, exclude = NULL)
table(d$day_of_birth, exclude = NULL)
# margin
d$year_of_birth = as.numeric(d$year_of_birth)
d$month_of_birth = as.numeric(d$month_of_birth)
d$day_of_birth = as.numeric(d$day_of_birth)
d$birthday <- paste(d$year_of_birth, d$month_of_birth,d$day_of_birth, sep = "-")
describe(d$birthday)
d$eligibility = "1970-10-05"
d$margin = as.Date(as.character(d$eligibility), format="%Y-%m-%d") - as.Date(as.character(d$birthday), format="%Y-%m-%d")
d$margin = as.numeric(d$margin)
describe(d$margin)
d = d[!is.na(d$margin),] # imposible birthdates
d$margin[d$margin>=0] = d$margin[d$margin>=0] + 1
describe(d$margin)
table(d$cep, exclude = NULL)
# treatment
d$treatment = 0
d$treatment[d$margin>0]=1
table(d$treatment)
table(d$margin[d$treatment==1])
table(d$margin[d$treatment==0])
# ideological outcomes
table(d$ideology_label, exclude = NULL)
d$ideology_label = as.numeric(d$ideology_label)
table(d$ideology_label, exclude = NULL)
d$ideo_label = d$ideology_label
d$ideo_label[d$ideo_label>5] = NA
table(d$ideo_label, exclude = NULL)
table(d$cep,d$ideo_label)
d$ideo_bin = 0
d$ideo_bin[d$ideology_label==1] = 1
d$ideo_bin[d$ideology_label==2] = 1
d$ideo_bin[d$ideology_label==3] = 1
d$ideo_bin[d$ideology_label==4] = 1
d$ideo_bin[d$ideology_label==5] = 1
d$ideo_bin[d$ideology_label==6] = 0
d$ideo_bin[d$ideology_label==7] = 0
table(d$ideo_bin, exclude = NULL)
#d = d[!is.na(d$ideo_bin),]
#table(d$ideo_bin, exclude = NULL)
d$right = 0
d$right[d$ideo_label==1]=1
d$right[d$ideo_label==2]=1
table(d$right)
d$left = 0
d$left[d$ideo_label==4]=1
d$left[d$ideo_label==5]=1
table(d$left)
d$center = 0
d$center[d$ideo_label==3]=1
table(d$center)
# drop no ideological label
table(d$cep,d$ideology_label)
####################################
# Main effect RDD
####################################
rm(list=ls())
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
################
# Prepare data
################
# reada data
d = read.dta13("~/Dropbox/Plebiscite Chile/01_data/clean data/cep_data_05feb2019.dta")
names(d)
table(d$cep, exclude = NULL)
table(d$cep,d$ideology_label)
# check data
table(d$year_of_birth, exclude = NULL)
d$year_miss = 0
d$year_miss[d$year_of_birth==999999]=1
table(d$year_miss)
table(d$cep,d$year_miss)
table(d$ideology_label, exclude = NULL)
table(d$cep,d$ideology_label, exclude = NULL)
# year of birth
table(d$year_of_birth, exclude = NULL)
d$year_of_birth[d$year_of_birth==99]=NA
d$year_of_birth[d$year_of_birth==2090]=NA
d$year_of_birth[d$year_of_birth==9999]=NA
d$year_of_birth[d$year_of_birth==999999]=NA
d$year_of_birth[d$year_of_birth==""]=NA
table(d$year_of_birth, exclude = NULL)
table(d$month_of_birth, exclude = NULL)
d$month_of_birth[d$month_of_birth==13]=NA
d$month_of_birth[d$month_of_birth==99]=NA
d$month_of_birth[d$month_of_birth==999999]=NA
d$month_of_birth[d$month_of_birth==""]=NA
table(d$month_of_birth, exclude = NULL)
table(d$day_of_birth, exclude = NULL)
d$day_of_birth[d$day_of_birth==0]=NA
d$day_of_birth[d$day_of_birth==39]=NA
d$day_of_birth[d$day_of_birth==99]=NA
d$day_of_birth[d$day_of_birth==999999]=NA
d$day_of_birth[d$day_of_birth==""]=NA
table(d$day_of_birth, exclude = NULL)
# subset
d = d[!is.na(d$year_of_birth),]
d = d[!is.na(d$month_of_birth),]
d = d[!is.na(d$day_of_birth),]
table(d$year_of_birth, exclude = NULL)
table(d$month_of_birth, exclude = NULL)
table(d$day_of_birth, exclude = NULL)
# margin
d$year_of_birth = as.numeric(d$year_of_birth)
d$month_of_birth = as.numeric(d$month_of_birth)
d$day_of_birth = as.numeric(d$day_of_birth)
d$birthday <- paste(d$year_of_birth, d$month_of_birth,d$day_of_birth, sep = "-")
describe(d$birthday)
d$eligibility = "1970-10-05"
d$margin = as.Date(as.character(d$eligibility), format="%Y-%m-%d") - as.Date(as.character(d$birthday), format="%Y-%m-%d")
d$margin = as.numeric(d$margin)
describe(d$margin)
d = d[!is.na(d$margin),] # imposible birthdates
d$margin[d$margin>=0] = d$margin[d$margin>=0] + 1
describe(d$margin)
table(d$cep, exclude = NULL)
# treatment
d$treatment = 0
d$treatment[d$margin>0]=1
table(d$treatment)
table(d$margin[d$treatment==1])
table(d$margin[d$treatment==0])
# ideological outcomes
table(d$ideology_label, exclude = NULL)
d$ideology_label = as.numeric(d$ideology_label)
table(d$ideology_label, exclude = NULL)
d$ideo_label = d$ideology_label
d$ideo_label[d$ideo_label>5] = NA
table(d$ideo_label, exclude = NULL)
table(d$cep,d$ideo_label)
d$ideo_bin = 0
d$ideo_bin[d$ideology_label==1] = 1
d$ideo_bin[d$ideology_label==2] = 1
d$ideo_bin[d$ideology_label==3] = 1
d$ideo_bin[d$ideology_label==4] = 1
d$ideo_bin[d$ideology_label==5] = 1
d$ideo_bin[d$ideology_label==6] = 0
d$ideo_bin[d$ideology_label==7] = 0
table(d$ideo_bin, exclude = NULL)
#d = d[!is.na(d$ideo_bin),]
#table(d$ideo_bin, exclude = NULL)
d$right = 0
d$right[d$ideo_label==1]=1
d$right[d$ideo_label==2]=1
table(d$right)
d$left = 0
d$left[d$ideo_label==4]=1
d$left[d$ideo_label==5]=1
table(d$left)
d$center = 0
d$center[d$ideo_label==3]=1
table(d$center)
# drop no ideological label
table(d$cep,d$ideology_label)
d = d[d$cep!=52,]
d = d[d$cep!=55,]
d = d[d$cep!=79,]
d = d[d$cep!=80,]
table(d$cep)
table(d$comuna, exclude = NULL)
####################################
# Aligned adjacent municipality analysis
####################################
rm(list=ls())
library(Hmisc)
library(ggplot2)
library(stargazer)
library(foreign)
library(rdrobust)
library(rdd)
library(readstata13)
library(gridExtra)
# load function that does clustered SEs
vcovCluster <- function(
model,
cluster
)
{
require(sandwich)
require(lmtest)
if(nrow(model.matrix(model))!=length(cluster)){
stop("check your data: cluster variable has different N than model")
}
M <- length(unique(cluster))
N <- length(cluster)
K <- model$rank
if(M<40){
warning("Fewer than 40 clusters, variances may be unreliable")
}
dfc <- (M/(M - 1)) * ((N - 1)/(N - K))
uj  <- apply(estfun(model), 2, function(x) tapply(x, cluster, sum));
rcse.cov <- dfc * sandwich(model, meat = crossprod(uj)/N)
return(rcse.cov)
}
################
# Prepare data
################
# reada data
d =  read.dta13("~/Dropbox/Crime Chile/01_data/clean data/local_crime_data_chile_2019april26.dta")
names(d)
# control
d$t_spill2 = 1 - d$t_spill
# spill
table(d$t_spill)
table(d$total_adjacent_county)
##############################################################################################
# Aligned adjacent municipalitys 1: Interaction with binary indicator: Property street crime
##############################################################################################
# main regression
d2 = d[!is.na(d$propstreetcrime_s),]
d2 = d2[d2$total_adjacent_county!=0,]
h1 = rdbwselect(d2$propstreetcrime_s,d2$margin,cluster = d2$cluster)$bws[1]
X = d2$margin
center = 0
bw = h1
d2$kweights = kernelwts(X, center, bw, kernel = "triangular")
# interaction 1
reg1 = lm(d2$propstreetcrime_s ~ d2$ruling + d2$t_spill + d2$t_spill*d2$ruling + d2$margin, weights = d2$kweights)
reg1_c <- round(coeftest(reg1, vcov = vcovCluster(reg1, cluster = d2$cluster)),4)
reg1_c
reg1 = lm(d2$propstreetcrime_s ~ d2$ruling + d2$t_spill + d2$t_spill*d2$ruling, weights = d2$kweights)
reg1_c <- round(coeftest(reg1, vcov = vcovCluster(reg1, cluster = d2$cluster)),4)
reg1_c
# interaction 1
reg1 = lm(d2$propstreetcrime_s ~ d2$ruling + d2$t_spill + d2$t_spill*d2$ruling + d2$margin, weights = d2$kweights)
reg1_c <- round(coeftest(reg1, vcov = vcovCluster(reg1, cluster = d2$cluster)),4)
reg1_c
bw
length(d2$propstreetcrime_s[d2$kweights!=0])
